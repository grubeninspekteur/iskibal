= AsciiDoc plus Iskara

This document describes how Iskara rule sources can be embedded in AsciiDoc.
It focusses on the externalization of rule metadata such as imports, facts, outputs, globals and decision tables so they can be maintained using standard AsciiDoc structures.

See the <<Iskara_Language_Reference.adoc#,Iskara Language Reference>> for the syntax of the rule language itself.

== Organizing rule sources

AsciiDoc documents may contain multiple rule fragments.
Listing blocks annotated with the `source,iskara` attribute become rule sections.
Rules can be freely mixed with other sections and then collected by a pre-processor before compilation.

Data required by the rules can be defined using structural blocks that are independent of the rule listings.
This allows data to be re-used, included from other files and even generated.

== Imports

Imports map identifiers used inside the rules to classes of the target language.
They are written as a definition list with the role `imports`:

[.imports]
====
Vehicle:: org.acme.Vehicle
Passenger:: org.acme.PersonImpl
====

Multiple import blocks are merged by the parser, allowing imports to be grouped and reused in different documents.

== Facts

Facts provide the named objects that are available to all rules.
They can be declared either as a definition list or as a three column table with the role `facts`.
The columns are *Fact name*, *Type* and an optional *Description*.
The actual column names are ignored, only the positions matter.

[cols="1,1,3",.facts]
|===
| Fact name | Type | Description

| vehicleCrossingTheBorder | Vehicle | The vehicle that arrived at the border checkpoint.
| prompt | Prompt | Allows to ask the user for input.
|===

== Outputs

Outputs are similar to facts but are produced by the rule execution.
They are written as a four column table with the role `outputs`.
The columns are *Output name*, *Type*, *Initial value* and an optional *Description*.

[cols="1,1,1,3",.outputs]
|===
| Output name | Type | Initial value | Description

| rejectionReasons | String[] | [] | List of reasons the border crossing was not allowed.
|===

== Globals

Additional global state can be declared using tables with the role `globals`.
The column order matches outputs, but the values are not returned to the caller.

== Data tables

AsciiDoc tables can hold external data referenced by rules.
Tables may be given an ID so that rule templates can refer to them via cross references.

.Vehicle weight limits
[#vehicle-weight-limits]
|===
| Type  | Maximum Weight
| Car   | 1.5t
| Lorry | 5t
|===

== Decision tables and rule templates

Decision tables are expressed by regular AsciiDoc tables and rule templates.
A rule template is a listing block with the role `rule-template` that contains placeholders using `%` to reference columns from a table.

[source,iskara,.rule-template]
----
When:
  $vehicle.type = %Type
  $vehicle.weight > %"Maximum Weight"
Then:
  $rejectionReasons add: "Vehicle overweight"
----

When a template cross references a table (for example `<<#vehicle-weight-limits>>`), the rule compiler generates concrete rules for each row.

== Includes and modularization

Because all of these structures are plain AsciiDoc, they can be stored in separate files and brought together with the standard `include::` directive.
This enables the creation of shared libraries of tables, globals and rule templates that can be combined to form larger rule bases.

